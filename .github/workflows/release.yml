name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract changelog
        id: changelog
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          CHANGELOG=$(awk -v ver="$VERSION" '
            $0 ~ "^## \\[" ver "\\]" { in_section=1; next }
            in_section && $0 ~ "^## \\[" { exit }
            in_section { print }
          ' CHANGELOG.md)
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create installer bundle directory
        run: |
          mkdir -p release/.terraform-azurerm-ai-installer/modules/powershell
          mkdir -p release/.terraform-azurerm-ai-installer/modules/bash

      - name: Write installer VERSION file
        run: |
          echo "${{ steps.get_version.outputs.VERSION }}" > release/.terraform-azurerm-ai-installer/VERSION

      - name: Copy installer files to bundle
        run: |
          # Copy main scripts
          cp installer/install-copilot-setup.ps1 release/.terraform-azurerm-ai-installer/
          cp installer/install-copilot-setup.sh release/.terraform-azurerm-ai-installer/
          cp installer/file-manifest.config release/.terraform-azurerm-ai-installer/

          # Copy PowerShell modules
          cp installer/modules/powershell/*.psm1 release/.terraform-azurerm-ai-installer/modules/powershell/

          # Copy Bash modules
          cp installer/modules/bash/*.sh release/.terraform-azurerm-ai-installer/modules/bash/

      - name: Build and copy offline payload (aii/) to bundle
        run: |
          set -euo pipefail

          payload_root="release/.terraform-azurerm-ai-installer/aii"
          mkdir -p "${payload_root}"

          # Copy only the AI infrastructure files referenced by the manifest.
          # This keeps the release bundle self-contained and avoids shipping unrelated repo content.
          copy_manifest_section() {
            local section="$1"

            awk -v section="[${section}]" '
              $0 ~ /^\[/ { in_section = ($0 == section) }
              in_section && $0 !~ /^\[/ {
                if ($0 ~ /^#/ || $0 ~ /^[[:space:]]*$/) next
                print $0
              }
            ' installer/file-manifest.config | while IFS= read -r relpath; do
              mkdir -p "${payload_root}/$(dirname "${relpath}")"
              cp "${relpath}" "${payload_root}/${relpath}"
            done
          }

          copy_manifest_section "MAIN_FILES"
          copy_manifest_section "INSTRUCTION_FILES"
          copy_manifest_section "PROMPT_FILES"
          copy_manifest_section "SKILL_FILES"
          copy_manifest_section "UNIVERSAL_FILES"

      - name: Generate installer payload checksum
        run: |
          set -euo pipefail

          installer_root="release/.terraform-azurerm-ai-installer"
          manifest_file="${installer_root}/file-manifest.config"
          payload_root="${installer_root}/aii"
          checksum_file="${installer_root}/aii.checksum"

          hash_file() {
            local file_path="$1"
            if command -v sha256sum >/dev/null 2>&1; then
              sha256sum "${file_path}" | awk '{print $1}'
            else
              shasum -a 256 "${file_path}" | awk '{print $1}'
            fi
          }

          tmp_file="$(mktemp)"
          manifest_hash="$(hash_file "${manifest_file}")"
          printf "%s  %s\n" "${manifest_hash}" "file-manifest.config" > "${tmp_file}"

          while IFS= read -r file; do
            rel_path="${file#${payload_root}/}"
            file_hash="$(hash_file "${file}")"
            printf "%s  %s\n" "${file_hash}" "aii/${rel_path}" >> "${tmp_file}"
          done < <(find "${payload_root}" -type f | LC_ALL=C sort)

          # IMPORTANT: hash the tmp file bytes directly so the trailing newline
          # is preserved (command substitution strips trailing newlines).
          overall_hash="$(hash_file "${tmp_file}")"

          version="$(cat "${installer_root}/VERSION" | tr -d '\r\n')"
          timestamp="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          printf "version=%s\ntimestamp=%s\nhash=%s\n" "${version}" "${timestamp}" "${overall_hash}" > "${checksum_file}"

          rm -f "${tmp_file}"

      - name: Verify installer bundle checksum
        shell: pwsh
        run: |
          pwsh -NoProfile -File ./tools/verify-bundle-checksum.ps1 -InstallerRoot ./release/.terraform-azurerm-ai-installer

      - name: Make bundled bash scripts executable
        run: |
          chmod +x release/.terraform-azurerm-ai-installer/install-copilot-setup.sh
          chmod +x release/.terraform-azurerm-ai-installer/modules/bash/*.sh

      - name: Create ZIP archive for Windows
        run: |
          cd release
          zip -r terraform-azurerm-ai-installer-v${{ steps.get_version.outputs.VERSION }}.zip .terraform-azurerm-ai-installer/

      - name: Create stable ZIP alias for latest
        run: |
          cd release
          cp terraform-azurerm-ai-installer-v${{ steps.get_version.outputs.VERSION }}.zip terraform-azurerm-ai-installer.zip

      - name: Create TAR.GZ archive for Linux/macOS
        run: |
          cd release
          tar -czf terraform-azurerm-ai-installer-v${{ steps.get_version.outputs.VERSION }}.tar.gz .terraform-azurerm-ai-installer/

      - name: Create stable TAR.GZ alias for latest
        run: |
          cd release
          cp terraform-azurerm-ai-installer-v${{ steps.get_version.outputs.VERSION }}.tar.gz terraform-azurerm-ai-installer.tar.gz

      - name: Create full source archive
        run: |
          # Create full release package (for advanced users)
          tar -czf release/terraform-azurerm-ai-assisted-development-v${{ steps.get_version.outputs.VERSION }}.tar.gz \
            --exclude='.git' \
            --exclude='release' \
            .

      - name: Generate checksums
        run: |
          cd release
          sha256sum *.tar.gz *.zip > checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Terraform AzureRM AI-Assisted Development v${{ steps.get_version.outputs.VERSION }}

            ${{ steps.changelog.outputs.CHANGELOG }}

            ### Quick Installation

            You can either install the **latest release** (stable URLs) or **pin a specific version** (tagged URLs).

            **Option A (recommended): Install latest**

            **Windows (PowerShell):**
            ```powershell
            # Download and extract installer to your user profile
            Invoke-WebRequest -Uri "https://github.com/WodansSon/terraform-azurerm-ai-assisted-development/releases/latest/download/terraform-azurerm-ai-installer.zip" -OutFile "$env:TEMP\terraform-azurerm-ai-installer.zip"
            Expand-Archive -Path "$env:TEMP\terraform-azurerm-ai-installer.zip" -DestinationPath "$env:USERPROFILE" -Force

            # Run installer pointing to your terraform-provider-azurerm repository
            & "$env:USERPROFILE\.terraform-azurerm-ai-installer\install-copilot-setup.ps1" -RepoDirectory "C:\path\to\terraform-provider-azurerm"
            ```

            **macOS/Linux (Bash):**
            ```bash
            # Download and extract installer to your user profile
            curl -L -o /tmp/terraform-azurerm-ai-installer.tar.gz "https://github.com/WodansSon/terraform-azurerm-ai-assisted-development/releases/latest/download/terraform-azurerm-ai-installer.tar.gz"
            tar -xzf /tmp/terraform-azurerm-ai-installer.tar.gz -C ~/

            # Run installer pointing to your terraform-provider-azurerm repository
            ~/.terraform-azurerm-ai-installer/install-copilot-setup.sh -repo-directory "/path/to/terraform-provider-azurerm"
            ```

            If you see a permission error, run:
            ```bash
            chmod +x ~/.terraform-azurerm-ai-installer/install-copilot-setup.sh
            ```

            **Option B: Pin this exact version (v${{ steps.get_version.outputs.VERSION }})**

            - Stable asset name (tagged URL):
              - `.../releases/download/v${{ steps.get_version.outputs.VERSION }}/terraform-azurerm-ai-installer.zip`
              - `.../releases/download/v${{ steps.get_version.outputs.VERSION }}/terraform-azurerm-ai-installer.tar.gz`
            - Versioned asset name (tagged URL):
              - `.../releases/download/v${{ steps.get_version.outputs.VERSION }}/terraform-azurerm-ai-installer-v${{ steps.get_version.outputs.VERSION }}.zip`
              - `.../releases/download/v${{ steps.get_version.outputs.VERSION }}/terraform-azurerm-ai-installer-v${{ steps.get_version.outputs.VERSION }}.tar.gz`

            Installation is a **two-step** process:
            1) **Extract** this release bundle into your user profile so the installer lives at `~/.terraform-azurerm-ai-installer/` (macOS/Linux) or `$env:USERPROFILE\.terraform-azurerm-ai-installer\` (Windows).
            2) **Run the installer** and point it at your local `terraform-provider-azurerm` checkout. It will copy the bundled AI instruction files and Agent Skills into that repo (primarily under `.github/`).

            For the full, canonical instructions and troubleshooting, see:
            - https://github.com/WodansSon/terraform-azurerm-ai-assisted-development/blob/main/installer/README.md
            - https://github.com/WodansSon/terraform-azurerm-ai-assisted-development#installation

            **Note:** The `-Bootstrap` flag is only needed for contributors working on this project itself, not for end users.

            ### Release Assets

            - **`terraform-azurerm-ai-installer.zip`** - Windows installer bundle (stable name for `releases/latest/download/`)
            - **`terraform-azurerm-ai-installer.tar.gz`** - Linux/macOS installer bundle (stable name for `releases/latest/download/`)
            - **`terraform-azurerm-ai-installer-v${{ steps.get_version.outputs.VERSION }}.zip`** - Windows installer bundle (recommended)
            - **`terraform-azurerm-ai-installer-v${{ steps.get_version.outputs.VERSION }}.tar.gz`** - Linux/macOS installer bundle (recommended)
            - **`terraform-azurerm-ai-assisted-development-v${{ steps.get_version.outputs.VERSION }}.tar.gz`** - Full source archive
            - **`checksums.txt`** - SHA256 checksums for all artifacts

            ### What's Included

            - AI instruction files for HashiCorp Terraform AzureRM Provider development
            - Installation scripts for Windows (PowerShell) and Linux/macOS (Bash)
            - All required modules bundled together
            - Configuration templates for VS Code and GitHub Copilot

            ### Documentation

            - [Installation Guide](https://github.com/WodansSon/terraform-azurerm-ai-assisted-development/blob/main/installer/README.md)
            - [Full Changelog](https://github.com/WodansSon/terraform-azurerm-ai-assisted-development/blob/main/CHANGELOG.md)
            - [Main README](https://github.com/WodansSon/terraform-azurerm-ai-assisted-development/blob/main/README.md)
          files: |
            release/terraform-azurerm-ai-installer.zip
            release/terraform-azurerm-ai-installer-v${{ steps.get_version.outputs.VERSION }}.zip
            release/terraform-azurerm-ai-installer.tar.gz
            release/terraform-azurerm-ai-installer-v${{ steps.get_version.outputs.VERSION }}.tar.gz
            release/terraform-azurerm-ai-assisted-development-v${{ steps.get_version.outputs.VERSION }}.tar.gz
            release/checksums.txt
          draft: false
          prerelease: false
